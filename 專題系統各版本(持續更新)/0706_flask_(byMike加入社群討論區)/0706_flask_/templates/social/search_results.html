<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æœå°‹çµæœ - {{ query }}</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/modules/social/social_main.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/modules/social/search_results.css') }}">
</head>

<body class="page-wrapper">

<!-- ===== é é¦– ===== -->
<header class="custom-header">
  <a href="/social/main" class="back-btn" title="è¿”å›ç¤¾ç¾¤">â®</a>

  <form class="search-bar" action="{{ url_for('social.search') }}" method="GET">
    <input type="text" name="q" class="search-input" placeholder="æœå°‹è²¼æ–‡ã€ä½¿ç”¨è€…â€¦" value="{{ query }}">
    <button type="submit" class="search-btn">ğŸ”</button>
  </form>

  <nav class="social-nav">
    <a href="/social/create_post" class="action-btn" title="æ–°å¢è²¼æ–‡">â•</a>
    <div class="more-wrapper">
      <button type="button" class="action-btn more-toggle" title="æ›´å¤š">â‹¯</button>
      <div class="more-menu">
        <button type="button" id="toggle-dark" class="more-item">ğŸŒ— æ·±è‰²æ¨¡å¼</button>
        <a href="#" class="more-item">âš™ï¸ å€‹äººè¨­å®š</a>
      </div>
    </div>
  </nav>
</header>

<!-- ===== ä¸»è¦å€åŸŸ ===== -->
<div class="content-flex">

  <!-- â€” å·¦å´æœå°‹ç¯©é¸ â€” -->
  <aside class="search-filter-panel">
    <h3>æœå°‹ç¯©é¸</h3>
    <ul class="filter-list">
      <li>
        <a href="{{ url_for('social.search', q=query, type='all') }}" 
           class="filter-item {{ 'active' if search_type == 'all' else '' }}">
          ğŸ“‹ å…¨éƒ¨çµæœ 
          <span class="filter-count">{{ total_results }}</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('social.search', q=query, type='posts') }}" 
           class="filter-item {{ 'active' if search_type == 'posts' else '' }}">
          ğŸ“ è²¼æ–‡ 
          <span class="filter-count">{{ posts|length }}</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('social.search', q=query, type='users') }}" 
           class="filter-item {{ 'active' if search_type == 'users' else '' }}">
          ğŸ‘¤ ç”¨æˆ¶ 
          <span class="filter-count">{{ users|length }}</span>
        </a>
      </li>
    </ul>
  </aside>

  <!-- â€” å³å´æœå°‹çµæœ â€” -->
  <section class="search-results-area">

    <!-- æœå°‹çµæœæ¨™é¡Œ -->
    <div class="search-header">
      {% if query %}
        <h2>æœå°‹ã€Œ{{ query }}ã€çš„çµæœ</h2>
        <p class="search-info">
          æ‰¾åˆ° {{ total_results }} å€‹çµæœ
          {% if search_type == 'posts' %}
            (è²¼æ–‡)
          {% elif search_type == 'users' %}
            (ç”¨æˆ¶)
          {% endif %}
        </p>
      {% else %}
        <h2>æœå°‹çµæœ</h2>
        <p class="search-info">è«‹è¼¸å…¥æœå°‹é—œéµå­—</p>
      {% endif %}
    </div>

    <!-- éŒ¯èª¤è¨Šæ¯ -->
    {% if error_message %}
    <div class="error-message">
      <div class="error-icon">âš ï¸</div>
      <p>{{ error_message }}</p>
    </div>
    {% endif %}

    <!-- æœå°‹çµæœå…§å®¹ -->
    <div class="search-results-content">

      <!-- ç”¨æˆ¶æœå°‹çµæœ -->
      {% if search_type in ['all', 'users'] and users %}
      <div class="users-section">
        <h3 class="section-title">ğŸ‘¤ ç”¨æˆ¶ ({{ users|length }})</h3>
        <div class="users-grid">
          {% for user in users %}
          <div class="user-card post-card">
            <div class="user-avatar">
              <span class="avatar-icon">ğŸ‘¤</span>
            </div>
            <div class="user-info">
              <h4 class="user-name">{{ user.username }}</h4>
              <p class="user-stats">
                {{ user.post_count }} ç¯‡è²¼æ–‡ Â· {{ user.likes_received }} å€‹è®š
              </p>
              <p class="user-joined">åŠ å…¥æ–¼ {{ user.created_at if user.created_at else 'æœªçŸ¥' }}</p>
            </div>
            <div class="user-actions">
              {% if current_user.is_authenticated and user.user_email != current_user.id %}
              <button class="follow-btn btn btn-sm btn-primary" data-user-email="{{ user.user_email }}" data-username="{{ user.username }}" title="è¿½è¹¤ç”¨æˆ¶">
                <span class="btn-emoji">â•</span> è¿½è¹¤
              </button>
              {% endif %}
              <button class="btn btn-sm btn-secondary view-user-posts" data-username="{{ user.username }}">
                <span class="btn-emoji">ğŸ‘ï¸</span> æŸ¥çœ‹è²¼æ–‡
              </button>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- è²¼æ–‡æœå°‹çµæœ -->
      {% if search_type in ['all', 'posts'] and posts %}
      <div class="posts-section">
        <h3 class="section-title">ğŸ“ è²¼æ–‡ ({{ posts|length }})</h3>
        <div class="posts-list">
          {% for post in posts %}
          <article class="search-post-card post-card" data-post-id="{{ post.post_id }}" data-mood="{{ post.mood or 'neutral' }}">
            <header class="post-header">
              <div class="post-author">
                <strong><a href="{{ url_for('social.user_posts', user_email=post.user_email) }}">{{ post.username }}</a></strong>
                {% if post.is_anonymous %}
                  <span class="anonymous-badge">
                    <span class="anonymous-icon">ğŸ‘¤</span> åŒ¿å
                  </span>
                {% endif %}
              </div>
              <span class="post-time" data-original-time="{{ post.created_at }}" title="ç™¼å¸ƒæ–¼: {{ post.created_at }}">{{ post.created_at }}</span>
            </header>
            
            <!-- å¿ƒæƒ…æ¨™ç±¤ -->
            <div class="mood-indicator">
              {% if post.mood == 'happy' %}
                <span class="mood-emoji">ğŸ˜„</span> é–‹å¿ƒ
              {% elif post.mood == 'sad' %}
                <span class="mood-emoji">ğŸ˜¢</span> é›£é
              {% elif post.mood == 'angry' %}
                <span class="mood-emoji">ğŸ˜¡</span> ç”Ÿæ°£
              {% elif post.mood == 'surprised' %}
                <span class="mood-emoji">ğŸ˜±</span> é©šè¨
              {% elif post.mood == 'relaxed' %}
                <span class="mood-emoji">ğŸ˜Œ</span> æ”¾é¬†
              {% else %}
                <span class="mood-emoji">ğŸ˜</span> å¹³å¸¸
              {% endif %}
            </div>
            
            <!-- è²¼æ–‡æ¨™é¡Œ -->
            {% if post.title and post.title.strip() %}
            <div class="post-title">
              <h4>{{ post.title }}</h4>
            </div>
            {% endif %}
            
            <!-- è²¼æ–‡å…§å®¹é è¦½ -->
            <div class="post-content-preview">
              {% set content_length = post.content|length %}
              {% if content_length > 150 %}
                {{ post.content[:150] }}...
              {% else %}
                {{ post.content }}
              {% endif %}
            </div>

            <!-- åœ–ç‰‡é è¦½ -->
            {% if post.image_url %}
            <div class="post-image-preview">
              <img src="{{ post.image_url }}" 
                   alt="è²¼æ–‡åœ–ç‰‡" 
                   style="max-width: 100px; height: 60px; object-fit: cover; border-radius: 4px;"
                   onerror="this.style.display='none';">
            </div>
            {% endif %}
            
            <footer class="post-footer">
              <div class="post-stats">
                <span class="likes-count">
                  <span class="stat-emoji">{{ 'ğŸ‘' if post.user_liked else 'ğŸ¤' }}</span>
                  {{ post.likes_count }}
                </span>
                <span class="comments-count">
                  <span class="stat-emoji">ğŸ’¬</span>
                  {{ post.comments|length if post.comments else 0 }}
                </span>
              </div>
              <div class="post-actions">
                {% if current_user.is_authenticated and post.user_email != current_user.id and not post.is_anonymous %}
                <button class="follow-btn btn btn-sm btn-primary" data-user-email="{{ post.user_email }}" data-username="{{ post.username }}" title="è¿½è¹¤ç”¨æˆ¶">
                  <span class="btn-emoji">â•</span> è¿½è¹¤
                </button>
                {% endif %}
                <a href="/social/main#post-{{ post.post_id }}" class="view-post-btn btn btn-sm btn-secondary">
                  <span class="btn-emoji">ğŸ‘ï¸</span> æŸ¥çœ‹å®Œæ•´è²¼æ–‡
                </a>
              </div>
            </footer>
          </article>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- æ²’æœ‰æœå°‹çµæœ -->
      {% if query and total_results == 0 %}
      <div class="no-results">
        <div class="no-results-icon">ğŸ”</div>
        <h3>æ²’æœ‰æ‰¾åˆ°ç›¸é—œçµæœ</h3>
        <p>æ‰¾ä¸åˆ°èˆ‡ã€Œ{{ query }}ã€ç›¸é—œçš„
          {% if search_type == 'posts' %}è²¼æ–‡
          {% elif search_type == 'users' %}ç”¨æˆ¶
          {% else %}å…§å®¹
          {% endif %}
        </p>
        <div class="no-results-suggestions">
          <h4>æœå°‹å»ºè­°ï¼š</h4>
          <ul>
            <li>æª¢æŸ¥æ‹¼å­—æ˜¯å¦æ­£ç¢º</li>
            <li>å˜—è©¦ä½¿ç”¨ä¸åŒçš„é—œéµå­—</li>
            <li>ä½¿ç”¨æ›´ç°¡çŸ­çš„æœå°‹è©</li>
            {% if search_type != 'all' %}
            <li><a href="{{ url_for('social.search', q=query, type='all') }}">æœå°‹æ‰€æœ‰é¡å‹çš„å…§å®¹</a></li>
            {% endif %}
          </ul>
        </div>
      </div>
      {% endif %}

      <!-- æ²’æœ‰è¼¸å…¥æœå°‹é—œéµå­— -->
      {% if not query %}
      <div class="no-query">
        <div class="no-query-icon">ğŸ’­</div>
        <h3>é–‹å§‹æœå°‹</h3>
        <p>åœ¨ä¸Šæ–¹æœå°‹æ¬„è¼¸å…¥é—œéµå­—ï¼Œå°‹æ‰¾æ„Ÿèˆˆè¶£çš„è²¼æ–‡å’Œç”¨æˆ¶</p>
        <div class="search-tips">
          <h4>æœå°‹æŠ€å·§ï¼š</h4>
          <ul>
            <li>è¼¸å…¥è²¼æ–‡æ¨™é¡Œæˆ–å…§å®¹ä¸­çš„é—œéµå­—</li>
            <li>æœå°‹ç”¨æˆ¶åç¨±</li>
            <li>ä½¿ç”¨å…·é«”çš„è©å½™æœƒæœ‰æ›´å¥½çš„æœå°‹çµæœ</li>
          </ul>
        </div>
      </div>
      {% endif %}

    </div><!-- /search-results-content -->

  </section><!-- /search-results-area -->

</div><!-- /content-flex -->

<!-- åŠŸèƒ½å°šæœªé–‹é€šå½ˆçª— -->
<div id="feature-modal" class="feature-modal-overlay">
  <div class="feature-modal-box">
    <h3>åŠŸèƒ½å°šæœªé–‹é€š</h3>
    <p>å¾ˆæŠ±æ­‰ï¼Œé€™å€‹åŠŸèƒ½å°šæœªé–‹é€šï¼Œæ•¬è«‹æœŸå¾…ï¼</p>
    <button onclick="closeFeatureModal()">çŸ¥é“äº†</button>
  </div>
</div>

{% include 'components/footer.html' %}

<script>
  // å®šç¾©ç•¶å‰ç”¨æˆ¶ä¿¡æ¯ï¼Œä¾›JavaScriptä½¿ç”¨
  const currentUserEmail = '{{ current_user.id if current_user.is_authenticated else "" }}';
  const searchQuery = '{{ query }}';
  const searchType = '{{ search_type }}';
</script>
<script src="{{ url_for('static', filename='js/base.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/social/search_results.js') }}"></script>
</body>
</html>
