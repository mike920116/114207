# å¿ƒç†å¥åº·æ—¥è¨˜å¹³å° - å°ˆæ¡ˆç²¾è¯æ–‡ä»¶ ğŸŒ±

## ğŸ¯ å°ˆæ¡ˆæ ¸å¿ƒæ¦‚è¦½

### å°ˆæ¡ˆå®šä½
**å¿ƒç†å¥åº·æ—¥è¨˜å¹³å°** - ä¸€å€‹èåˆ AI æŠ€è¡“çš„ç¾ä»£åŒ–å¿ƒç†å¥åº·æ”¯æ´å¹³å°

### æ ¸å¿ƒåƒ¹å€¼
- ğŸ¤– **AI æ™ºèƒ½åˆ†æ**: è‡ªå‹•æƒ…ç·’åˆ†æèˆ‡å€‹äººåŒ–å»ºè­°
- ğŸ’¬ **çœŸäººå®¢æœ**: AI + çœŸäººå®¢æœç„¡ç¸«åˆ‡æ›
- ğŸ‘¥ **ç¤¾äº¤æ”¯æŒ**: å®‰å…¨çš„æƒ…ç·’åˆ†äº«èˆ‡äº’å‹•ç©ºé–“
- ğŸ“Š **æ•¸æ“šæ´å¯Ÿ**: å®Œæ•´çš„æƒ…ç·’è¿½è¹¤èˆ‡ç®¡ç†å¾Œå°

## ğŸ—ï¸ æŠ€è¡“æ¶æ§‹ç²¾è¦

### æŠ€è¡“æ£§
```yaml
å¾Œç«¯æ¡†æ¶: Python Flask 3.1.0
è³‡æ–™åº«: MySQL + é€£ç·šæ± ç®¡ç† (DBUtils + PyMySQL)
å³æ™‚é€šè¨Š: Flask-SocketIO + eventlet
AI æœå‹™: Dify API æ•´åˆ
éƒµä»¶æœå‹™: SMTP (Zoho)
å¤–éƒ¨æ•´åˆ: LINE Bot SDK
å‰ç«¯æŠ€è¡“: HTML5 + CSS3 + Vanilla JavaScript
æ¨¡æ¿å¼•æ“: Jinja2
```

### æ¶æ§‹è¨­è¨ˆç†å¿µ
```mermaid
graph TB
    A[ä½¿ç”¨è€…ä»‹é¢å±¤] --> B[æ¥­å‹™é‚è¼¯å±¤]
    B --> C[è³‡æ–™å­˜å–å±¤]
    D[å¤–éƒ¨æœå‹™å±¤] --> B
    
    A1[Templates + Static] --> A
    B1[Flask Blueprints] --> B
    C1[MySQL + é€£ç·šæ± ] --> C
    D1[Dify AI + LINE Bot] --> D
```

## ğŸ“ æ¨¡çµ„åŒ–æ¶æ§‹è©³è§£

### æ ¸å¿ƒæ¨¡çµ„æ¸…å–®
```
services/
â”œâ”€â”€ user/           ğŸ‘¤ ä½¿ç”¨è€…ç³»çµ± (è¨»å†Š/ç™»å…¥/è¨­å®š)
â”œâ”€â”€ diary/          ğŸ“– æ™ºèƒ½æ—¥è¨˜ (CRUD + AI åˆ†æ)
â”œâ”€â”€ ai/             ğŸ¤– AI èŠå¤©æ©Ÿå™¨äºº
â”œâ”€â”€ admin/          ğŸ›¡ï¸ ç®¡ç†å¾Œå° (ç”¨æˆ¶/å…§å®¹/å®¢æœ)
â”œâ”€â”€ social/         ğŸ‘¥ ç¤¾äº¤äº’å‹• (è²¼æ–‡/ç•™è¨€/æŒ‰è®š)
â”œâ”€â”€ line/           ğŸ“± LINE Bot æ•´åˆ
â”œâ”€â”€ support/        â“ å¹«åŠ©æ–‡æª”
â”œâ”€â”€ announcement/   ğŸ“¢ å…¬å‘Šç³»çµ±
â””â”€â”€ socketio_manager.py ğŸ“¡ å³æ™‚é€šè¨Šç®¡ç†
```

### Blueprint è¨»å†Šæ¶æ§‹
```python
# app.py - æ¨¡çµ„åŒ–è¨»å†Š
app.register_blueprint(user_bp,      url_prefix="/user")
app.register_blueprint(diary_bp,     url_prefix="/diary")
app.register_blueprint(ai_chat_bp,   url_prefix="/ai")
app.register_blueprint(admin_bp,     url_prefix="/admin")
app.register_blueprint(social_bp,    url_prefix="/social")
```

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½æ·±åº¦è§£æ

### 1. æ™ºèƒ½æ—¥è¨˜ç³»çµ± (`services/diary/`)
**æŠ€è¡“äº®é»**: Dify API æƒ…ç·’åˆ†æ + å‰ç«¯å³æ™‚åé¥‹
```python
# æ ¸å¿ƒæµç¨‹
ç”¨æˆ¶è¼¸å…¥ â†’ AI åˆ†æ â†’ è³‡æ–™åº«å„²å­˜ â†’ å³æ™‚ UI æ›´æ–°
```

**å‰ç«¯äº¤äº’**:
```javascript
// diary_form.js - æƒ…ç·’é¸æ“‡ + AI å›é¥‹
const response = await fetch('/diary/save', {
    method: 'POST',
    body: JSON.stringify({
        content: diaryContent,
        emotion: selectedEmotion
    })
});
```

### 2. AI èŠå¤©ç³»çµ± (`services/ai/`)
**æŠ€è¡“äº®é»**: å°è©±é€£çºŒæ€§ + çœŸäººå®¢æœç„¡ç¸«åˆ‡æ›
```python
# é—œéµæ©Ÿåˆ¶
session_id â†’ conversation_id â†’ Dify API â†’ WebSocket å»£æ’­
```

**è½‰çœŸäººæµç¨‹**:
```mermaid
sequenceDiagram
    participant U as ä½¿ç”¨è€…
    participant AI as AIç³»çµ±
    participant A as ç®¡ç†å“¡
    
    U->>AI: å°è©±ä¸­
    U->>AI: é»æ“Šã€Œæ±‚åŠ©ã€
    AI->>A: WebSocket é€šçŸ¥
    A->>U: ç®¡ç†å“¡æ¥æ‰‹
    Note over AI: AI è‡ªå‹•æš«åœ
```

### 3. å³æ™‚é€šè¨Šæ¶æ§‹ (`socketio_manager.py`)
**æŠ€è¡“äº®é»**: å‘½åç©ºé–“åˆ†é›¢ + æœƒè©±ç‹€æ…‹ç®¡ç†
```python
# æ ¸å¿ƒäº‹ä»¶
@socketio.on("connect", namespace="/chat")          # é€£ç·šç®¡ç†
@socketio.on("subscribe_to_session", namespace="/chat")  # è¨‚é–±æœƒè©±
@socketio.on("msg_added", namespace="/chat")        # è¨Šæ¯å»£æ’­
```

### 4. ç®¡ç†å¾Œå°ç³»çµ± (`services/admin/`)
**æŠ€è¡“äº®é»**: æ¬Šé™ç™½åå–® + å³æ™‚å®¢æœé¢æ¿
```python
# æ¬Šé™æ§åˆ¶
ADMIN_EMAILS = set(os.getenv("ADMIN_EMAILS", "").split(","))

def is_admin():
    return current_user.is_authenticated and current_user.id in ADMIN_EMAILS
```

### 5. ç¤¾äº¤äº’å‹•ç³»çµ± (`services/social/`)
**æŠ€è¡“äº®é»**: åŒ¿åç™¼æ–‡ + è©•è«–èšåˆ
```python
# è³‡æ–™èšåˆæŸ¥è©¢
SELECT p.*, COUNT(l.Like_id) AS likes_count
FROM Posts p
LEFT JOIN Likes l ON p.Post_id = l.Post_id
GROUP BY p.Post_id
```

## ğŸ’¾ è³‡æ–™åº«è¨­è¨ˆç²¾è¦

### é€£ç·šæ± é…ç½®
```python
# utils/db.py - é«˜æ•ˆèƒ½é€£ç·šç®¡ç†
pool = PooledDB(
    creator=pymysql,
    mincached=5,      # æœ€å°é€£ç·šæ•¸
    maxcached=10,     # æœ€å¤§ç©ºé–’é€£ç·š
    maxconnections=20, # ç¸½é€£ç·šä¸Šé™
    blocking=True,    # é€£ç·šç­‰å¾…
    autocommit=True   # è‡ªå‹•æäº¤
)
```

### æ ¸å¿ƒè³‡æ–™è¡¨
```sql
-- ä½¿ç”¨è€…ç³»çµ±
User (User_Email, User_name, password_hash, bio, ...)

-- æ—¥è¨˜ç³»çµ±
DiaryRecords (Diary_id, User_Email, Diary_Content, AI_analysis_content, ...)

-- ç¤¾äº¤ç³»çµ±
Posts (Post_id, User_Email, Content, Is_public, ...)
Comments (Comment_id, Post_id, User_Email, Content, ...)
Likes (Like_id, Post_id, User_Email, ...)

-- AI èŠå¤©ç³»çµ±
AIChatSessions (session_id, user_email, need_human, is_open, ...)
AIChatLogs (id, session_id, role, message, ...)
```

## ğŸ” å®‰å…¨æ€§è¨­è¨ˆ

### 1. èªè­‰èˆ‡æˆæ¬Š
```python
# å¯†ç¢¼åŠ å¯†
bcrypt.hashpw(password.encode('utf-8'), salt)

# æ¬Šé™æ§åˆ¶
@login_required
@admin_required
```

### 2. ç’°å¢ƒè®Šæ•¸ç®¡ç†
```env
# .env é…ç½®
SECRET_KEY=flask_secret_key
DB_PASSWORD=database_password
DIFY_API_KEY_For_Diary=ai_service_key
ADMIN_EMAILS=admin@example.com
```

### 3. SQL æ³¨å…¥é˜²è­·
```python
# åƒæ•¸åŒ–æŸ¥è©¢
cursor.execute("SELECT * FROM User WHERE User_Email = %s", (email,))
```

## ğŸ¨ å‰ç«¯æ¶æ§‹è¨­è¨ˆ

### æ¨¡çµ„åŒ– JavaScript
```
static/js/
â”œâ”€â”€ base.js                    # å…¨åŸŸåŠŸèƒ½ (å´é‚Šæ¬„/ä¸»é¡Œ)
â””â”€â”€ modules/
    â”œâ”€â”€ diary/
    â”‚   â”œâ”€â”€ diary_form.js      # æ—¥è¨˜è¡¨å–®äº’å‹•
    â”‚   â””â”€â”€ diary_list.js      # åˆ—è¡¨ç¯©é¸æ’åº
    â”œâ”€â”€ ai/
    â”‚   â””â”€â”€ ai_chat.js         # WebSocket èŠå¤©
    â”œâ”€â”€ admin/
    â”‚   â””â”€â”€ admin.js           # å¾Œå°å®¢æœé¢æ¿
    â””â”€â”€ social/
        â””â”€â”€ social_main.js     # ç¤¾äº¤äº’å‹•
```

### å‰å¾Œç«¯é€šè¨Šæ¨¡å¼
```javascript
// AJAX + WebSocket æ··åˆæ¶æ§‹
// 1. è³‡æ–™æ“ä½œä½¿ç”¨ AJAX
fetch('/api/endpoint', {method: 'POST', ...})

// 2. å³æ™‚é€šè¨Šä½¿ç”¨ WebSocket
socket.emit('subscribe_to_session', {session_id, role})
socket.on('msg_added', handleNewMessage)
```

## ğŸš€ éƒ¨ç½²èˆ‡ç¶­é‹

### é–‹ç™¼ç’°å¢ƒå•Ÿå‹•
```bash
# 1. å®‰è£ä¾è³´
pip install -r requirements.txt

# 2. è¨­å®šç’°å¢ƒè®Šæ•¸
cp .env.example .env

# 3. å•Ÿå‹•æ‡‰ç”¨
python app.py  # é–‹ç™¼æ¨¡å¼ (å« SocketIO)
```

### ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²
```python
# app.py - WSGI åŒ…è£
if __name__ == '__main__':
    socketio.run(app, debug=True)
else:
    application = WSGIApp(socketio, app)  # ç”Ÿç”¢ç’°å¢ƒ
```

### æ€§èƒ½å„ªåŒ–è¦é»
1. **é€£ç·šæ± ç®¡ç†**: è‡ªå‹•é€£ç·šå¾©ç”¨èˆ‡å›æ”¶
2. **éœæ…‹è³‡æº**: CSS/JS æ¨¡çµ„åŒ–è¼‰å…¥
3. **WebSocket**: äº‹ä»¶é©…å‹•æ¸›å°‘è¼ªè©¢
4. **è³‡æ–™åº«**: ç´¢å¼•å„ªåŒ–èˆ‡æŸ¥è©¢èšåˆ

## ğŸ“Š ç³»çµ±ç›£æ§èˆ‡æ—¥èªŒ

### æ—¥èªŒç³»çµ±
```python
# çµ±ä¸€æ—¥èªŒé…ç½®
logging.basicConfig(
    filename="logs/app.log",
    level=logging.INFO,
    format="%(asctime)s %(levelname)s: %(message)s"
)
```

### ç®¡ç†å“¡å„€è¡¨æ¿
- ğŸ“Š ç³»çµ±çµ±è¨ˆ (ç”¨æˆ¶æ•¸ã€æ—¥è¨˜æ•¸)
- ğŸ‘¥ ç”¨æˆ¶åˆ—è¡¨èˆ‡æ´»å‹•è¨˜éŒ„
- ğŸ“ æ—¥è¨˜å…§å®¹å¯©æ ¸
- ğŸ’¬ å³æ™‚å®¢æœé¢æ¿

## ğŸ“ å­¸ç¿’åƒ¹å€¼èˆ‡æŠ€è¡“äº®é»

### 1. ç¾ä»£ Web é–‹ç™¼æœ€ä½³å¯¦è¸
- **æ¨¡çµ„åŒ–è¨­è¨ˆ**: Flask Blueprint æ¶æ§‹
- **å‰å¾Œç«¯åˆ†é›¢**: AJAX + RESTful API
- **å³æ™‚é€šè¨Š**: WebSocket äº‹ä»¶é©…å‹•
- **å®‰å…¨æ€§**: èªè­‰æˆæ¬Š + åƒæ•¸åŒ–æŸ¥è©¢

### 2. AI æŠ€è¡“æ•´åˆ
- **å¤–éƒ¨ API æ•´åˆ**: Dify æœå‹™ä¸²æ¥
- **å°è©±ç‹€æ…‹ç®¡ç†**: session + conversation æ©Ÿåˆ¶
- **æ™ºèƒ½åˆ‡æ›**: AI â†” çœŸäººå®¢æœç„¡ç¸«è½‰æ›

### 3. ç³»çµ±è¨­è¨ˆæ€ç¶­
- **é«˜ä½µç™¼è™•ç†**: é€£ç·šæ±  + éåŒæ­¥ I/O
- **ç”¨æˆ¶é«”é©—**: æ¼¸é€²å¼è¼‰å…¥ + å³æ™‚åé¥‹
- **å¯ç¶­è­·æ€§**: åˆ†å±¤æ¶æ§‹ + æ¨¡çµ„è§£è€¦

## ğŸ”® æœªä¾†æ“´å±•æ–¹å‘

### æŠ€è¡“å‡ç´š
- [ ] Redis å¿«å–å±¤
- [ ] Docker å®¹å™¨åŒ–
- [ ] å¾®æœå‹™æ‹†åˆ†
- [ ] å‰ç«¯æ¡†æ¶åŒ– (Vue.js/React)

### åŠŸèƒ½å¢å¼·
- [ ] æƒ…ç·’è¶¨å‹¢åˆ†æ
- [ ] ç¾¤çµ„æ²»ç™‚åŠŸèƒ½
- [ ] è¡Œå‹•è£ç½® APP
- [ ] å¤šèªè¨€æ”¯æ´

---

## ğŸ“ ç¸½çµ

é€™å€‹å°ˆæ¡ˆå±•ç¾äº†ç¾ä»£ Web æ‡‰ç”¨é–‹ç™¼çš„å®Œæ•´æŠ€è¡“æ£§ï¼Œå¾åº•å±¤çš„è³‡æ–™åº«é€£ç·šæ± ç®¡ç†ï¼Œåˆ°ä¸Šå±¤çš„ AI æœå‹™æ•´åˆï¼Œæ¯ä¸€å€‹æŠ€è¡“é¸å‹éƒ½æœ‰å…¶æ·±æ€ç†Ÿæ…®çš„ç†ç”±ã€‚

**æ ¸å¿ƒç«¶çˆ­åŠ›**:
1. **æŠ€è¡“æ·±åº¦**: é€£ç·šæ± ã€WebSocketã€AI æ•´åˆ
2. **æ¶æ§‹è¨­è¨ˆ**: æ¨¡çµ„åŒ–ã€åˆ†å±¤ã€å¯æ“´å±•
3. **ç”¨æˆ¶é«”é©—**: å³æ™‚äº’å‹•ã€æ™ºèƒ½åˆ†æã€å®‰å…¨ä¿éšœ
4. **å•†æ¥­åƒ¹å€¼**: å¿ƒç†å¥åº·å¸‚å ´çš„æŠ€è¡“è§£æ±ºæ–¹æ¡ˆ

é€™ä¸åƒ…æ˜¯ä¸€å€‹æŠ€è¡“å°ˆæ¡ˆï¼Œæ›´æ˜¯ä¸€å€‹å±•ç¤ºç¾ä»£ Web é–‹ç™¼èƒ½åŠ›å’Œç³»çµ±æ€ç¶­çš„å„ªç§€ä½œå“ã€‚
