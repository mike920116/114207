{% extends 'admin/layout.html' %}

{% block title %}Admin - å›é¥‹è©³æƒ… #{{ report.Report_id }}{% endblock %}

{% block extra_css %}
<!-- CSS å·²æ•´åˆåˆ° admin.css ä¸­ -->
{% endblock %}

{% block content %}
<div class="admin-content">
  <!-- é é¢æ¨™é¡Œ -->
  <div class="page-header">
    <h1 class="page-title">å›é¥‹è©³æƒ… #{{ report.Report_id }}</h1>
    <div class="page-actions">
      <a href="{{ url_for('admin.admin_reports') }}" class="btn btn-secondary">
        <i class="icon-back"></i> è¿”å›åˆ—è¡¨
      </a>
    </div>
  </div>

  <!-- èˆ‰å ±ç‹€æ…‹å¡ç‰‡ -->
  <div class="status-card status-{{ report.Status }}">
    <div class="status-header">
      <span class="status-badge status-{{ report.Status }}">
        {% if report.Status == 'pending' %}å¾…è™•ç†
        {% elif report.Status == 'accepted' %}å·²æ¥å—
        {% elif report.Status == 'rejected' %}å·²æ‹’çµ•
        {% elif report.Status == 'closed' %}å·²é—œé–‰
        {% endif %}
      </span>
      <div class="status-meta">
        <span class="created-time">æäº¤æ–¼ {{ report.Created_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
        {% if report.Updated_at != report.Created_at %}
        <span class="updated-time">æ›´æ–°æ–¼ {{ report.Updated_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="detail-grid">
    <!-- èˆ‰å ±å…§å®¹ -->
    <div class="detail-section">
      <h2 class="section-title">æ„è¦‹å…§å®¹</h2>
      <div class="detail-card">
        <!-- èˆ‰å ±è€…è³‡è¨Š -->
        <div class="user-info-section">
          <h3>æ„è¦‹å›é¥‹è€…è³‡è¨Š</h3>
          <div class="user-details">
            <div class="user-avatar">
              {% if report.User_Avatar %}
              <img src="{{ url_for('static', filename=report.User_Avatar) }}" alt="User Avatar">
              {% else %}
              <div class="avatar-placeholder">{{ report.User_Email[0].upper() }}</div>
              {% endif %}
            </div>
            <div class="user-meta">
              <div class="user-email">{{ report.User_Email }}</div>
              {% if report.User_name %}
              <div class="user-name">{{ report.User_name }}</div>
              {% endif %}
              <div class="user-details-extra">
                <span class="user-badge">
                  ğŸ“… {{ report.Created_at.strftime('%Y-%m-%d') }}
                </span>
                {% if report.Status == 'pending' %}
                <span class="user-badge new-user">
                  â³ å¾…è™•ç†
                </span>
                {% elif report.Status == 'accepted' %}
                <span class="user-badge verified">
                  âœ… å·²è™•ç†
                </span>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- èˆ‰å ±è©³æƒ… -->
        <div class="report-details">
          <div class="detail-row">
            <div class="detail-label">æ„è¦‹ä¸»é¡Œ</div>
            <div class="detail-value">{{ report.Theme }}</div>
          </div>

          <div class="detail-row">
            <div class="detail-label">å•é¡Œé¡å‹</div>
            <div class="detail-value">
              {% for option in report.Options %}
              <span class="option-tag">{{ option }}</span>
              {% endfor %}
            </div>
          </div>

          {% if report.Post_id %}
          <div class="detail-row">
            <div class="detail-label">ç›¸é—œè²¼æ–‡</div>
            <div class="detail-value">
              <a href="#" class="link">è²¼æ–‡ #{{ report.Post_id }}</a>
              {% if post_info %}
              <div class="post-preview">
                <div class="post-author">{{ post_info.User_Email }} ({{ post_info.User_name }})</div>
                <div class="post-content">{{ post_info.Content[:200] }}{% if post_info.Content|length > 200 %}...{% endif %}</div>
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}

          <div class="detail-row">
            <div class="detail-label">è©³ç´°èªªæ˜</div>
            <div class="detail-value">
              <div class="content-text">{{ report.Context }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- AI åˆ†æçµæœ -->
    {% if report.AI_Valid is not none %}
    <div class="detail-section">
      <h2 class="section-title">AI æ™ºèƒ½åˆ†æ</h2>
      <div class="detail-card ai-analysis-card">
        <div class="ai-header">
          <div class="ai-result {{ 'valid' if report.AI_Valid else 'invalid' }}">
            <i class="icon-ai"></i>
            <span>{{ 'æœ‰æ•ˆæ„è¦‹' if report.AI_Valid else 'éœ€è¦é€²ä¸€æ­¥ç¢ºèª' }}</span>
          </div>
          {% if report.AI_Confidence %}
          <div class="ai-confidence">
            <span class="confidence-label">å¯ä¿¡åº¦</span>
            <div class="confidence-bar">
              <div class="confidence-fill" data-confidence="{{ (report.AI_Confidence * 100)|int }}"></div>
            </div>
            <span class="confidence-value">{{ "%.0f"|format(report.AI_Confidence * 100) }}%</span>
          </div>
          {% endif %}
        </div>

        {% if report.AI_Reason %}
        <div class="ai-detail">
          <div class="detail-label">åˆ†æåŸå› </div>
          <div class="detail-value">{{ report.AI_Reason }}</div>
        </div>
        {% endif %}

        {% if report.AI_Suggest_Action %}
        <div class="ai-detail">
          <div class="detail-label">å»ºè­°è¡Œå‹•</div>
          <div class="detail-value">{{ report.AI_Suggest_Action }}</div>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <!-- ç®¡ç†å“¡è™•ç†å€ -->
    <div class="detail-section">
      <h2 class="section-title">ç®¡ç†å“¡è™•ç†</h2>
      <div class="detail-card">
        {% if report.Staff_Reply %}
        <div class="current-reply">
          <h3>ç›®å‰å›è¦†</h3>
          <div class="reply-content">{{ report.Staff_Reply }}</div>
          <div class="reply-time">å›è¦†æ™‚é–“ï¼š{{ report.Updated_at.strftime('%Y-%m-%d %H:%M:%S') }}</div>
        </div>
        {% endif %}

        <!-- è™•ç†è¡¨å–® -->
        <form method="POST" action="{{ url_for('admin.admin_report_update', report_id=report.Report_id) }}" class="admin-form">
          <div class="form-group">
            <label for="status" class="form-label">è™•ç†ç‹€æ…‹</label>
            <select id="status" name="status" class="form-control" required>
              <option value="pending" {{ 'selected' if report.Status == 'pending' }}>å¾…è™•ç†</option>
              <option value="accepted" {{ 'selected' if report.Status == 'accepted' }}>å·²æ¥å—</option>
              <option value="rejected" {{ 'selected' if report.Status == 'rejected' }}>å·²æ‹’çµ•</option>
              <option value="closed" {{ 'selected' if report.Status == 'closed' }}>å·²é—œé–‰</option>
            </select>
          </div>

          <div class="form-group">
            <label for="staff_reply" class="form-label">ç®¡ç†å“¡å›è¦†</label>
            <textarea id="staff_reply" 
                      name="staff_reply" 
                      class="form-control" 
                      rows="5" 
                      placeholder="è«‹å¡«å¯«å°ä½¿ç”¨è€…çš„å›è¦†å…§å®¹...">{{ report.Staff_Reply or '' }}</textarea>
            <small class="form-text">æ­¤å›è¦†å°‡é¡¯ç¤ºçµ¦ä½¿ç”¨è€…</small>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" name="notify_user" checked>
              <span class="checkmark"></span>
              é€šçŸ¥ä½¿ç”¨è€…è™•ç†çµæœ
            </label>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary">æ›´æ–°è™•ç†çµæœ</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- è™•ç†æ­·ç¨‹ -->
  {% if audit_logs %}
  <div class="detail-section full-width">
    <h2 class="section-title">è™•ç†æ­·ç¨‹</h2>
    <div class="timeline-container">
      <div class="timeline">
        {% for log in audit_logs %}
        <div class="timeline-item">
          <div class="timeline-marker {{ log.Action }}">
            {% if log.Action == 'ai_check' %}
            <i class="icon-ai"></i>
            {% elif log.Action == 'manual_review' %}
            <i class="icon-user"></i>
            {% elif log.Action == 'notify_user' %}
            <i class="icon-bell"></i>
            {% endif %}
          </div>
          <div class="timeline-content">
            <div class="timeline-header">
              <span class="action-name">
                {% if log.Action == 'ai_check' %}AI è‡ªå‹•æª¢æŸ¥
                {% elif log.Action == 'manual_review' %}äººå·¥å¯©æ ¸
                {% elif log.Action == 'notify_user' %}ä½¿ç”¨è€…é€šçŸ¥
                {% endif %}
              </span>
              <span class="action-time">{{ log.Created_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
            </div>
            <div class="timeline-description">{{ log.Description }}</div>
            {% if log.Performed_by != 'system' %}
            <div class="timeline-performer">åŸ·è¡Œè€…ï¼š{{ log.Performed_by }}</div>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}
