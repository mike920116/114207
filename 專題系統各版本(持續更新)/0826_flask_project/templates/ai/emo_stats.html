{% extends "base.html" %}

{% block title %}æƒ…ç·’æ´å¯Ÿ - çµ±è¨ˆåˆ†æ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/modules/ai/emo_stats.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
{% endblock %}

{% block content %}
<!-- åŸå‹Cçš„èƒŒæ™¯å‹•ç•«ç³»çµ± -->
<div class="particle-background" id="particleBackground"></div>
<div class="rainbow-overlay"></div>

<!-- ä¸‰æ¬„å¸ƒå±€å®¹å™¨ -->
<div class="emotion-three-column-container" id="statsContainer">
  <!-- å·¦å´é¢æ¿ (çµ±è¨ˆæ§åˆ¶èˆ‡å¿«é€Ÿæ“ä½œ) -->
  <div class="left-panel glass-panel" id="leftPanel">
    <button class="panel-toggle-btn" id="leftPanelToggle" title="æ”¶èµ·/å±•é–‹å·¦å´é¢æ¿">
      <i class="fas fa-chevron-left"></i>
    </button>
    <div class="autonomous-left-header">
      <h3>ğŸ¯ çµ±è¨ˆæ§åˆ¶</h3>
    </div>
    <div class="panel-content">
      <!-- çµ±è¨ˆæ§åˆ¶å€åŸŸ -->
      <div class="stats-controls-panel">
        <div class="control-section">
          <h5><i class="fas fa-calendar-alt"></i> æ™‚é–“ç¯„åœ</h5>
          <div class="date-range-selector">
            <select id="dateRange" class="form-select">
              <option value="today">ä»Šå¤©</option>
              <option value="7" selected>æœ€è¿‘ 7 å¤©</option>
              <option value="14">æœ€è¿‘ 14 å¤©</option>
              <option value="30">æœ€è¿‘ 30 å¤©</option>
            </select>
          </div>
        </div>
        
        <div class="control-section">
          <h5><i class="fas fa-sync-alt"></i> æ•¸æ“šæ“ä½œ</h5>
          <div class="control-buttons">
            <button id="refreshBtn" class="control-btn primary">
              <i class="fas fa-sync-alt"></i> é‡æ–°æ•´ç†
            </button>
            <button id="exportDataBtn" class="control-btn secondary">
              <i class="fas fa-download"></i> åŒ¯å‡ºæ•¸æ“š
            </button>
          </div>
        </div>
      </div>
      
      <!-- ä»Šæ—¥ç¸½é è¦½ -->
      <div class="quick-preview-section">
        <h5><i class="fas fa-tachometer-alt"></i> ä»Šæ—¥ç¸½é è¦½</h5>
        <div class="quick-stats-grid">
          <div class="quick-stat-item">
            <div class="quick-stat-icon">ğŸ’¬</div>
            <div class="quick-stat-content">
              <span class="quick-stat-label">ç¸½äº’å‹•</span>
              <span id="quickTotalInteractions" class="quick-stat-value">--</span>
            </div>
          </div>
          <div class="quick-stat-item">
            <div class="quick-stat-icon">ğŸ’¡</div>
            <div class="quick-stat-content">
              <span class="quick-stat-label">æƒ…ç·’å‘</span>
              <span id="quickEmotionDirection" class="quick-stat-value">--</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- å¿«é€Ÿå°èˆª -->
      <div class="quick-navigation">
        <h5><i class="fas fa-link"></i> å¿«é€Ÿå°èˆª</h5>
        <a href="/ai/emotion" class="nav-link">
          <i class="fas fa-arrow-left"></i> è¿”å›æƒ…ç·’ AI
        </a>
        <a href="/ai/emo_stats" class="nav-link active">
          <i class="fas fa-chart-line"></i> æƒ…ç·’æ´å¯Ÿ
        </a>
      </div>
    </div>
  </div>

  
  <!-- ä¸­å¤®çµ±è¨ˆå€åŸŸ -->
  <div class="stats-main-container">
    <div class="stats-main-header">
      <h2>ğŸ­ æƒ…ç·’æ´å¯Ÿçµ±è¨ˆåˆ†æ</h2>
      <div class="date-range-info" id="dateRangeInfo">è¿‘ 7 å¤©æ•¸æ“š</div>
    </div>

    <!-- çµ±è¨ˆæ‘˜è¦å€åŸŸ -->
    <div class="stats-summary-section">
      <div class="stats-cards-grid">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-comments"></i>
          </div>
          <div class="stat-content">
            <h3>ç¸½äº’å‹•æ¬¡æ•¸</h3>
            <span id="totalInteractions" class="stat-value">è¼‰å…¥ä¸­...</span>
            <small class="stat-desc">AI å°è©±äº’å‹•ç¸½æ•¸</small>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-heart"></i>
          </div>
          <div class="stat-content">
            <h3>ä¸»å°æƒ…ç·’</h3>
            <span id="dominantEmotion" class="stat-value">è¼‰å…¥ä¸­...</span>
            <small class="stat-desc">æœ€å¸¸å‡ºç¾çš„æƒ…ç·’</small>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-star"></i>
          </div>
          <div class="stat-content">
            <h3>å¹³å‡ä¿¡å¿ƒåº¦</h3>
            <span id="avgConfidence" class="stat-value">è¼‰å…¥ä¸­...</span>
            <small class="stat-desc">æƒ…ç·’åˆ†ææº–ç¢ºåº¦</small>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-balance-scale"></i>
          </div>
          <div class="stat-content">
            <h3>æƒ…ç·’ç©©å®šåº¦</h3>
            <span id="emotionStability" class="stat-value">è¼‰å…¥ä¸­...</span>
            <small class="stat-desc">æƒ…ç·’è®ŠåŒ–ç©©å®šç¨‹åº¦</small>
          </div>
        </div>
      </div>
    </div>

    <!-- åœ–è¡¨åˆ†æå€åŸŸ -->
    <div class="charts-analysis-section">
      <div class="charts-grid">
        <!-- æƒ…ç·’è¶¨å‹¢åœ– -->
        <div class="chart-container">
          <div class="chart-header">
            <h3><i class="fas fa-line-chart"></i> æƒ…ç·’è¶¨å‹¢åˆ†æ</h3>
            <p class="chart-desc">æŸ¥çœ‹æ‚¨çš„æƒ…ç·’è®ŠåŒ–è¶¨å‹¢</p>
          </div>
          <div class="chart-wrapper">
            <canvas id="emotionTrendChart"></canvas>
          </div>
        </div>
        
        <!-- æƒ…ç·’åˆ†å¸ƒåœ– -->
        <div class="chart-container">
          <div class="chart-header">
            <h3><i class="fas fa-pie-chart"></i> æƒ…ç·’åˆ†å¸ƒçµ±è¨ˆ</h3>
            <p class="chart-desc">ä¸åŒæƒ…ç·’çš„æ¯”ä¾‹åˆ†å¸ƒ</p>
          </div>
          <div class="chart-wrapper">
            <canvas id="emotionDistributionChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  
  <!-- å³å´é¢æ¿ (æ­·å²è¨˜éŒ„èˆ‡è©³ç´°åˆ†æ) -->
  <div class="right-panel glass-panel" id="rightPanel">
    <button class="panel-toggle-btn" id="rightPanelToggle" title="æ”¶èµ·/å±•é–‹å³å´é¢æ¿">
      <i class="fas fa-chevron-right"></i>
    </button>
    <div class="autonomous-right-header">
      <h3>ğŸ“Š æ­·å²è¨˜éŒ„</h3>
    </div>
    <div class="panel-content">
      <!-- æ­·å²è¨˜éŒ„å€åŸŸ -->
      <div class="history-section-compact">
        <div class="section-header">
          <h5><i class="fas fa-history"></i> æœ€è¿‘è¨˜éŒ„</h5>
          <button id="showMoreHistory" class="show-more-btn">
            <i class="fas fa-eye"></i>
          </button>
        </div>
        
        <div class="history-list" id="historyList">
          <div class="history-item loading">
            <div class="history-content">
              <div class="history-emotion">è¼‰å…¥ä¸­...</div>
              <div class="history-time">--</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- ä¸»é¡Œåˆ‡æ›æ§åˆ¶ -->
      <div class="theme-controls" id="themeControls">
        <h5>
          ğŸ¨ ä¸»é¡Œåˆ‡æ›
          <button class="theme-toggle-btn" id="themeToggleBtn" title="å±•é–‹/æ”¶åˆä¸»é¡Œé¸é …">
            <i class="fas fa-chevron-up"></i>
          </button>
        </h5>
        <div class="theme-buttons">
          <button class="theme-btn" data-theme="day" title="ä¸»é¡Œ:æ™¨æ˜Ÿ">â˜€ï¸</button>
          <button class="theme-btn" data-theme="sunset" title="ä¸»é¡Œ:çƒˆæ—¥">ğŸŒ…</button>
          <button class="theme-btn" data-theme="night" title="ä¸»é¡Œ:å¤œæ£®">ğŸŒ™</button>
        </div>
      </div>
      
      <!-- è©³ç´°åˆ†æå€åŸŸ -->
      <div class="detailed-analysis">
        <h5><i class="fas fa-analytics"></i> è©³ç´°åˆ†æ</h5>
        <div class="analysis-content" id="analysisContent">
          <div class="analysis-item">
            <div class="analysis-label">æƒ…ç·’è®ŠåŒ–è¶¨å‹¢</div>
            <div class="analysis-value" id="emotionTrend">åˆ†æä¸­...</div>
          </div>
          <div class="analysis-item">
            <div class="analysis-label">æ´»èºæ™‚æ®µ</div>
            <div class="analysis-value" id="activeTime">åˆ†æä¸­...</div>
          </div>
          <div class="analysis-item">
            <div class="analysis-label">å»ºè­°</div>
            <div class="analysis-value" id="recommendation">åˆ†æä¸­...</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- æ­·å²è¨˜éŒ„è©³ç´°è¦–çª— -->
<div class="history-detail-modal" id="historyDetailModal" style="display: none;">
  <div class="modal-overlay"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ“‹ è©³ç´°æ­·å²è¨˜éŒ„</h3>
      <button class="modal-close-btn" id="historyModalClose">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="history-table-wrapper">
        <table id="historyTable" class="emotion-history-table">
          <thead>
            <tr>
              <th>æ—¥æœŸæ™‚é–“</th>
              <th>ä¸»å°æƒ…ç·’</th>
              <th>ä¿¡å¿ƒåº¦</th>
              <th>æ•´é«”èªèª¿</th>
              <th>è¨Šæ¯é è¦½</th>
            </tr>
          </thead>
          <tbody id="historyTableBody">
            <tr>
              <td colspan="5" class="loading-cell">è¼‰å…¥æ­·å²è¨˜éŒ„ä¸­...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
  <div class="loading-content">
    <i class="fas fa-spinner fa-spin"></i>
    <p>æ­£åœ¨è¼‰å…¥æ•¸æ“š...</p>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/modules/ai/emo_stats.js') }}"></script>
<script>
// é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–æƒ…ç·’çµ±è¨ˆåŠŸèƒ½
    if (typeof EmotionStats !== 'undefined') {
        EmotionStats.init();
    } else {
        console.error('EmotionStats module not loaded');
    }
    
    // åˆå§‹åŒ–ä¸»é¡Œå’Œé¢æ¿æ§åˆ¶
    initThemeControls();
    initPanelControls();
});

// åˆå§‹åŒ–ä¸»é¡Œæ§åˆ¶
function initThemeControls() {
    const themeButtons = document.querySelectorAll('.theme-btn');
    themeButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const theme = this.dataset.theme;
            document.body.className = document.body.className.replace(/\b\w*-theme\b/g, '');
            document.body.classList.add(theme + '-theme');
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            themeButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
    
    // è¨­å®šé è¨­ä¸»é¡Œ
    document.body.classList.add('night-theme');
    document.querySelector('[data-theme="night"]').classList.add('active');
}

// åˆå§‹åŒ–é¢æ¿æ§åˆ¶
function initPanelControls() {
    const leftToggle = document.getElementById('leftPanelToggle');
    const rightToggle = document.getElementById('rightPanelToggle');
    const container = document.getElementById('statsContainer');
    const leftPanel = document.getElementById('leftPanel');
    const rightPanel = document.getElementById('rightPanel');
    
    if (leftToggle) {
        leftToggle.addEventListener('click', function() {
            leftPanel.classList.toggle('collapsed');
            container.classList.toggle('left-collapsed');
            
            const icon = this.querySelector('i');
            if (leftPanel.classList.contains('collapsed')) {
                icon.className = 'fas fa-chevron-right';
            } else {
                icon.className = 'fas fa-chevron-left';
            }
        });
    }
    
    if (rightToggle) {
        rightToggle.addEventListener('click', function() {
            rightPanel.classList.toggle('collapsed');
            container.classList.toggle('right-collapsed');
            
            const icon = this.querySelector('i');
            if (rightPanel.classList.contains('collapsed')) {
                icon.className = 'fas fa-chevron-left';
            } else {
                icon.className = 'fas fa-chevron-right';
            }
        });
    }
}
</script>
{% endblock %}
