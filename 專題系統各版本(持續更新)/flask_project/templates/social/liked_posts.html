<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å–œæ­¡çš„è²¼æ–‡ | ç¤¾ç¾¤äº’å‹•</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/modules/social/social_main.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/modules/social/social_tabs.css') }}">
</head>

<body class="page-wrapper"><!-- flex ç¸±å‘ -->

<!-- ===== é é¦– ===== -->
<header class="custom-header">
  <a href="/social/main" class="back-btn" title="è¿”å›ç¤¾ç¾¤ä¸»é ">â®</a>

  <div class="header-title">
    <h1>ğŸ’– å–œæ­¡çš„è²¼æ–‡</h1>
    <p class="header-subtitle">æ‚¨æŒ‰è®šéçš„æ‰€æœ‰è²¼æ–‡ ({{ total_liked_posts }} ç¯‡)</p>
  </div>

  <nav class="social-nav">
    <a href="/social/create_post" class="action-btn" title="æ–°å¢è²¼æ–‡">â•</a>

    <div class="more-wrapper">
      <button type="button" class="action-btn more-toggle" title="æ›´å¤š">â‹¯</button>
      <div class="more-menu">
        <button type="button" id="toggle-dark" class="more-item">ğŸŒ— æ·±è‰²æ¨¡å¼</button>
        <a href="/settings/profile" class="more-item">âš™ï¸ å€‹äººè¨­å®š</a>
      </div>
    </div>
  </nav>
</header>

<!-- ===== ä¸»è¦å€åŸŸï¼šå·¦å³é›™æ¬„ ===== -->
<div class="content-flex">

  <!-- â€” å·¦å´å›ºå®šæ¨™ç±¤ï¼ˆç¨ç«‹æ»¾å‹•ï¼‰ â€” -->
  <aside class="tag-panel">
    <!-- å¿«é€Ÿå°èˆª -->
    <div class="main-tabs">
      <a href="/social/main" class="main-tab" data-tab="back-to-main">
        <span class="tab-icon">ğŸ”™</span>
        <span class="tab-text">è¿”å›ä¸»é </span>
      </a>
      <div class="main-tab active" data-tab="liked-posts">
        <span class="tab-icon">ğŸ’–</span>
        <span class="tab-text">å–œæ­¡çš„è²¼æ–‡</span>
        <span class="tab-count">{{ total_liked_posts }}</span>
      </div>
    </div>
    
    <!-- è²¼æ–‡ç¯©é¸ -->
    <div class="sub-tabs">
      <div class="sub-tab-header">ğŸ“Š ç¯©é¸æ¢ä»¶</div>
      <ul>
        <li data-filter="all" class="tag active">ğŸ“‹ å…¨éƒ¨ <span class="tag-count" id="count-all">{{ total_liked_posts }}</span></li>
        <li data-filter="recent" class="tag">â° æœ€è¿‘æŒ‰è®š <span class="tag-count" id="count-recent">0</span></li>
        <li data-filter="happy" class="tag">ğŸ˜„ é–‹å¿ƒ <span class="tag-count" id="count-happy">0</span></li>
        <li data-filter="sad" class="tag">ğŸ˜¢ é›£é <span class="tag-count" id="count-sad">0</span></li>
        <li data-filter="angry" class="tag">ğŸ˜¡ ç”Ÿæ°£ <span class="tag-count" id="count-angry">0</span></li>
        <li data-filter="surprised" class="tag">ğŸ˜± é©šè¨ <span class="tag-count" id="count-surprised">0</span></li>
        <li data-filter="relaxed" class="tag">ğŸ˜Œ æ”¾é¬† <span class="tag-count" id="count-relaxed">0</span></li>
      </ul>
    </div>
    
    <!-- çµ±è¨ˆä¿¡æ¯ -->
    <div class="sub-tabs">
      <div class="sub-tab-header">ğŸ“ˆ çµ±è¨ˆä¿¡æ¯</div>
      <div class="stats-panel">
        <div class="stat-item">
          <span class="stat-icon">ğŸ’–</span>
          <span class="stat-value">{{ total_liked_posts }}</span>
          <span class="stat-label">æŒ‰è®šè²¼æ–‡</span>
        </div>
        <div class="stat-item">
          <span class="stat-icon">ğŸ“…</span>
          <span class="stat-value" id="liked-days-count">-</span>
          <span class="stat-label">æ´»èºå¤©æ•¸</span>
        </div>
      </div>
    </div>
  </aside>

  <!-- â€” å³å´å…§å®¹æ»¾å‹•å€ â€” -->
  <section class="scroll-area">

    <!-- ç”¨æˆ¶ç­‰ç´šä¿¡æ¯å¡ç‰‡ -->
    {% if user_level_info %}
    <div class="user-level-card" id="user-level-card" data-level="{{ user_level_info.current_level.title if user_level_info.current_level else 'æ–°æ‰‹æ‘æ°‘' }}">
      <div class="level-header">
        <div class="level-icon">
          <span class="level-emoji">{{ user_level_info.current_level.emoji if user_level_info.current_level else 'ğŸŒ±' }}</span>
        </div>
        <div class="level-info">
          <h3 class="level-title">{{ current_user.username if current_user.is_authenticated else 'æ–°æ‰‹æ‘æ°‘' }}</h3>
          <p class="level-description">{{ user_level_info.current_level.description if user_level_info.current_level else 'å‰›åŠ å…¥ç¤¾ç¾¤çš„æ–°æœ‹å‹' }}</p>
        </div>
        <div class="level-points">
          <span class="points-value">{{ user_level_info.points if user_level_info else 0 }}</span>
          <span class="points-label">ç©åˆ†</span>
        </div>
      </div>
      
      <div class="level-progress">
        <div class="progress-bar">
          <div class="progress-fill" style="width: {{ user_level_info.progress_to_next if user_level_info else 0 }}%"></div>
        </div>
        <div class="progress-text">
          <span class="current-progress">{{ user_level_info.progress_to_next if user_level_info else 0 }}%</span>
          <span class="next-level">ä¸‹ä¸€ç´šï¼š{{ user_level_info.next_level.title if user_level_info.next_level else 'æ´»èºå±…æ°‘' }}</span>
        </div>
      </div>
      
      <div class="level-stats">
        <div class="stat-item">
          <span class="stat-icon">ğŸ“</span>
          <span class="stat-value">{{ user_level_info.stats.posts_count if user_level_info.stats else 0 }}</span>
          <span class="stat-label">ç™¼æ–‡</span>
        </div>
        <div class="stat-item">
          <span class="stat-icon">ğŸ‘</span>
          <span class="stat-value">{{ user_level_info.stats.likes_received if user_level_info.stats else 0 }}</span>
          <span class="stat-label">ç²è®š</span>
        </div>
        <div class="stat-item">
          <span class="stat-icon">ğŸ’¬</span>
          <span class="stat-value">{{ user_level_info.stats.comments_received if user_level_info.stats else 0 }}</span>
          <span class="stat-label">ç•™è¨€</span>
        </div>
        <div class="stat-item">
          <span class="stat-icon">ğŸ“…</span>
          <span class="stat-value">{{ user_level_info.stats.login_days if user_level_info.stats else 1 }}</span>
          <span class="stat-label">å¤©æ•¸</span>
        </div>
      </div>
      
      <!-- ç¤¾äº¤çµ±è¨ˆ -->
      <div class="social-stats">
        <div class="social-stat-item" data-stat="followers" style="cursor: pointer;" title="é»æ“ŠæŸ¥çœ‹ç²‰çµ²åˆ—è¡¨">
          <span class="social-stat-icon">ğŸ‘¥</span>
          <span class="social-stat-number" id="followers-count">-</span>
          <span class="social-stat-label">ç²‰çµ²</span>
        </div>
        <div class="social-stat-item" data-stat="following" style="cursor: pointer;" title="é»æ“ŠæŸ¥çœ‹è¿½è¹¤åˆ—è¡¨">
          <span class="social-stat-icon">ğŸ””</span>
          <span class="social-stat-number" id="following-count">-</span>
          <span class="social-stat-label">è¿½è¹¤</span>
        </div>
        <div class="social-stat-item active" data-stat="liked-posts" title="ç•¶å‰é é¢">
          <span class="social-stat-icon">ğŸ’–</span>
          <span class="social-stat-number">{{ total_liked_posts }}</span>
          <span class="social-stat-label">å–œæ­¡</span>
        </div>
      </div>
      
      <!-- æŸ¥çœ‹ç­‰ç´šè¦ç¯„ -->
      <div class="level-actions">
        <a href="/social/level_guide" class="btn btn-info btn-sm">
          <span class="btn-emoji">ğŸ“–</span> æŸ¥çœ‹ç­‰ç´šè¦ç¯„
        </a>
        <a href="/social/main" class="btn btn-secondary btn-sm">
          <span class="btn-emoji">ğŸ”™</span> è¿”å›ä¸»é 
        </a>
      </div>
    </div>
    {% endif %}

    <!-- éŒ¯èª¤è¨Šæ¯ -->
    {% if error_message %}
    <div class="error-message">
      <div class="error-content">
        <span class="error-icon">âš ï¸</span>
        <p class="error-text">{{ error_message }}</p>
        <a href="/social/main" class="btn btn-primary">è¿”å›ä¸»é </a>
      </div>
    </div>
    {% endif %}

    <!-- ç©ºç‹€æ…‹ -->
    {% if total_liked_posts == 0 and not error_message %}
    <div class="empty-state">
      <div class="empty-content">
        <span class="empty-icon">ğŸ’”</span>
        <h3 class="empty-title">é‚„æ²’æœ‰æŒ‰è®šçš„è²¼æ–‡</h3>
        <p class="empty-description">åˆ°ç¤¾ç¾¤ä¸»é ç‚ºæ‚¨å–œæ­¡çš„è²¼æ–‡æŒ‰è®šå§ï¼</p>
        <a href="/social/main" class="btn btn-primary">
          <span class="btn-emoji">ğŸ“‹</span> ç€è¦½è²¼æ–‡
        </a>
      </div>
    </div>
    {% endif %}

    <!-- --- å–œæ­¡çš„è²¼æ–‡æ¸…å–® --- -->
    {% if posts %}
    <div class="posts-container" id="posts-container">
      {% for post in posts %}
      <article class="post-card" 
               data-post-id="{{ post.post_id }}" 
               data-mood="{{ post.mood }}" 
               data-author="{{ post.user_email }}"
               data-liked-date="{{ post.liked_at }}">
        
        <!-- è²¼æ–‡é ­éƒ¨ -->
        <header class="post-header">
          <div class="post-author">
            <div class="author-avatar">
              {% if post.is_anonymous %}
                <span class="avatar-icon">ğŸ‘¤</span>
              {% else %}
                <span class="avatar-icon">{{ post.username[0] if post.username else '?' }}</span>
              {% endif %}
            </div>
            <div class="author-info">
              <h4 class="author-name">{{ post.username }}</h4>
              <div class="post-meta">
                <time class="post-time" title="ç™¼æ–‡æ™‚é–“">{{ post.created_at }}</time>
                <span class="liked-time" title="æŒ‰è®šæ™‚é–“">ğŸ’– {{ post.liked_at }}</span>
                {% if post.mood %}
                <span class="mood-tag mood-{{ post.mood }}" title="å¿ƒæƒ…">
                  {% if post.mood == 'happy' %}ğŸ˜„{% elif post.mood == 'sad' %}ğŸ˜¢{% elif post.mood == 'angry' %}ğŸ˜¡{% elif post.mood == 'surprised' %}ğŸ˜±{% elif post.mood == 'relaxed' %}ğŸ˜Œ{% else %}ğŸ˜{% endif %}
                </span>
                {% endif %}
              </div>
            </div>
          </div>
          
          <!-- è¿½è¹¤æŒ‰éˆ• -->
          {% if not post.is_anonymous and post.user_email != current_user.id %}
          <div class="post-actions">
            <button class="follow-btn {{ 'following' if post.is_following else '' }}" 
                    data-user-email="{{ post.user_email }}"
                    title="{{ 'å–æ¶ˆè¿½è¹¤' if post.is_following else 'è¿½è¹¤ç”¨æˆ¶' }}">
              <span class="follow-text">{{ 'å·²è¿½è¹¤' if post.is_following else 'è¿½è¹¤' }}</span>
            </button>
          </div>
          {% endif %}
        </header>

        <!-- è²¼æ–‡å…§å®¹ -->
        <div class="post-content">
          {% if post.title %}
          <h3 class="post-title">{{ post.title }}</h3>
          {% endif %}
          <div class="post-text">{{ post.content }}</div>
          {% if post.image_url %}
          <div class="post-image">
            <img src="{{ post.image_url }}" alt="è²¼æ–‡åœ–ç‰‡" loading="lazy">
          </div>
          {% endif %}
        </div>

        <!-- è²¼æ–‡åº•éƒ¨ -->
        <footer class="post-footer">
          <div class="post-stats">
            <button class="like-btn active" data-post-id="{{ post.post_id }}" title="å·²æŒ‰è®š">
              <span class="like-icon">â¤ï¸</span>
              <span class="like-count">{{ post.likes_count }}</span>
            </button>
            <button class="comment-btn" data-post-id="{{ post.post_id }}" title="æŸ¥çœ‹ç•™è¨€">
              <span class="comment-icon">ğŸ’¬</span>
              <span class="comment-count">{{ post.comments|length }}</span>
            </button>
            <!-- ç§»é™¤æŒ‰è®šæŒ‰éˆ• -->
            <button class="unlike-btn" data-post-id="{{ post.post_id }}" title="ç§»é™¤å–œæ­¡">
              <span class="unlike-icon">ğŸ’”</span>
              <span class="unlike-text">ç§»é™¤</span>
            </button>
          </div>
        </footer>

        <!-- ç•™è¨€å€åŸŸï¼ˆæ‘ºç–Šï¼‰ -->
        {% if post.comments %}
        <div class="comments-section" style="display: none;">
          <div class="comments-list" data-post-id="{{ post.post_id }}">
            {% for comment in post.comments %}
            <div class="comment-item" data-comment-id="{{ comment.comment_id }}">
              <div class="comment-header">
                <div class="comment-author">
                  <span class="comment-avatar">{{ comment.username[0] if comment.username else '?' }}</span>
                  <span class="comment-name">{{ comment.username }}</span>
                  {% if not post.is_anonymous and comment.user_email != current_user.id and comment.user_email != post.user_email %}
                  <button class="follow-btn {{ 'following' if comment.is_following else '' }}" 
                          data-user-email="{{ comment.user_email }}"
                          title="{{ 'å–æ¶ˆè¿½è¹¤' if comment.is_following else 'è¿½è¹¤ç”¨æˆ¶' }}">
                    <span class="follow-text">{{ 'å·²è¿½è¹¤' if comment.is_following else 'è¿½è¹¤' }}</span>
                  </button>
                  {% endif %}
                </div>
                <time class="comment-time">{{ comment.created_at }}</time>
              </div>
              <div class="comment-content">
                {% if comment.reply_to_username %}
                <span class="reply-to">å›è¦† @{{ comment.reply_to_username }}ï¼š</span>
                {% endif %}
                {{ comment.content }}
              </div>
              <div class="comment-actions">
                <button class="reply-comment-btn" data-comment-id="{{ comment.comment_id }}" data-username="{{ comment.username }}">å›è¦†</button>
                {% if comment.user_email == current_user.id %}
                <button class="edit-comment-btn" data-comment-id="{{ comment.comment_id }}">ç·¨è¼¯</button>
                <button class="delete-comment-btn" data-comment-id="{{ comment.comment_id }}">åˆªé™¤</button>
                {% endif %}
              </div>
            </div>
            {% endfor %}
          </div>
          
          <!-- æ–°å¢ç•™è¨€è¡¨å–® -->
          <form class="comment-form" data-post-id="{{ post.post_id }}">
            <div class="comment-input-group">
              <input type="text" class="comment-input" placeholder="æ–°å¢ç•™è¨€..." maxlength="500">
              <input type="hidden" class="reply-to-id">
              <input type="hidden" class="reply-to-username">
              <button type="submit" class="comment-submit-btn">ç™¼é€</button>
            </div>
            <div class="reply-info" style="display: none;">
              <span class="reply-text">å›è¦† <span class="reply-target"></span></span>
              <button type="button" class="cancel-reply-btn">å–æ¶ˆ</button>
            </div>
          </form>
        </div>
        {% endif %}

      </article>
      {% endfor %}
    </div>
    {% endif %}

  </section>

</div>

<!-- JavaScript -->
<script src="{{ url_for('static', filename='js/base.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/social/social_main.js') }}"></script>
<script>
// åˆå§‹åŒ–å–œæ­¡çš„è²¼æ–‡é é¢
document.addEventListener('DOMContentLoaded', function() {
    // æ›´æ–°ç¯©é¸è¨ˆæ•¸å™¨
    updateFilterCounts();
    
    // è¼‰å…¥ç¤¾äº¤çµ±è¨ˆ
    loadSocialStats();
    
    // ç¶å®šäº‹ä»¶ç›£è½å™¨
    bindEventListeners();
    
    // åˆå§‹åŒ–ç¯©é¸åŠŸèƒ½
    initializeFilters();
    
    console.log('å–œæ­¡çš„è²¼æ–‡é é¢å·²åˆå§‹åŒ–');
});

// æ›´æ–°ç¯©é¸è¨ˆæ•¸å™¨
function updateFilterCounts() {
    const posts = document.querySelectorAll('.post-card');
    const counts = {
        all: posts.length,
        recent: 0,
        happy: 0,
        sad: 0,
        angry: 0,
        surprised: 0,
        relaxed: 0
    };
    
    // è¨ˆç®—æœ€è¿‘ä¸€é€±çš„æŒ‰è®šè²¼æ–‡
    const oneWeekAgo = new Date();
    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
    
    posts.forEach(post => {
        const mood = post.dataset.mood;
        const likedDate = new Date(post.dataset.likedDate);
        
        if (mood && counts.hasOwnProperty(mood)) {
            counts[mood]++;
        }
        
        if (likedDate >= oneWeekAgo) {
            counts.recent++;
        }
    });
    
    // æ›´æ–°è¨ˆæ•¸å™¨é¡¯ç¤º
    Object.keys(counts).forEach(filter => {
        const element = document.getElementById(`count-${filter}`);
        if (element) {
            element.textContent = counts[filter];
        }
    });
    
    // è¨ˆç®—æ´»èºå¤©æ•¸ï¼ˆæœ‰æŒ‰è®šæ´»å‹•çš„å¤©æ•¸ï¼‰
    const likedDates = Array.from(posts).map(post => 
        new Date(post.dataset.likedDate).toDateString()
    );
    const uniqueDays = new Set(likedDates).size;
    const likedDaysElement = document.getElementById('liked-days-count');
    if (likedDaysElement) {
        likedDaysElement.textContent = uniqueDays;
    }
}

// è¼‰å…¥ç¤¾äº¤çµ±è¨ˆ
function loadSocialStats() {
    fetch('/social/get_social_stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('followers-count').textContent = data.followers_count;
                document.getElementById('following-count').textContent = data.following_count;
            }
        })
        .catch(error => {
            console.error('è¼‰å…¥ç¤¾äº¤çµ±è¨ˆå¤±æ•—:', error);
        });
}

// ç¶å®šäº‹ä»¶ç›£è½å™¨
function bindEventListeners() {
    // ç§»é™¤å–œæ­¡æŒ‰éˆ•
    document.addEventListener('click', function(e) {
        if (e.target.closest('.unlike-btn')) {
            const unlikeBtn = e.target.closest('.unlike-btn');
            const postId = unlikeBtn.dataset.postId;
            removeLike(postId);
        }
    });
}

// ç§»é™¤å–œæ­¡
function removeLike(postId) {
    if (!confirm('ç¢ºå®šè¦ç§»é™¤å°é€™ç¯‡è²¼æ–‡çš„å–œæ­¡å—ï¼Ÿ')) {
        return;
    }
    
    fetch(`/social/toggle_like/${postId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && !data.is_liked) {
            // ç§»é™¤æˆåŠŸï¼Œéš±è—è©²è²¼æ–‡
            const postCard = document.querySelector(`[data-post-id="${postId}"]`);
            if (postCard) {
                postCard.style.transition = 'opacity 0.3s ease';
                postCard.style.opacity = '0';
                setTimeout(() => {
                    postCard.remove();
                    updateFilterCounts();
                    
                    // æ›´æ–°ç¸½æ•¸
                    const totalCountElements = document.querySelectorAll('.tab-count, .social-stat-number');
                    totalCountElements.forEach(el => {
                        const currentCount = parseInt(el.textContent) || 0;
                        if (currentCount > 0) {
                            el.textContent = currentCount - 1;
                        }
                    });
                    
                    // å¦‚æœæ²’æœ‰è²¼æ–‡äº†ï¼Œé¡¯ç¤ºç©ºç‹€æ…‹
                    const remainingPosts = document.querySelectorAll('.post-card');
                    if (remainingPosts.length === 0) {
                        location.reload();
                    }
                }, 300);
            }
            
            showToast('å·²ç§»é™¤å–œæ­¡', 'success');
        } else {
            showToast(data.message || 'æ“ä½œå¤±æ•—', 'error');
        }
    })
    .catch(error => {
        console.error('ç§»é™¤å–œæ­¡å¤±æ•—:', error);
        showToast('æ“ä½œå¤±æ•—', 'error');
    });
}

// åˆå§‹åŒ–ç¯©é¸åŠŸèƒ½
function initializeFilters() {
    const filterTags = document.querySelectorAll('.tag[data-filter]');
    
    filterTags.forEach(tag => {
        tag.addEventListener('click', function() {
            // ç§»é™¤å…¶ä»–æ¨™ç±¤çš„ active ç‹€æ…‹
            filterTags.forEach(t => t.classList.remove('active'));
            
            // æ·»åŠ ç•¶å‰æ¨™ç±¤çš„ active ç‹€æ…‹
            this.classList.add('active');
            
            // åŸ·è¡Œç¯©é¸
            const filter = this.dataset.filter;
            filterPosts(filter);
        });
    });
}

// ç¯©é¸è²¼æ–‡
function filterPosts(filter) {
    const posts = document.querySelectorAll('.post-card');
    
    posts.forEach(post => {
        let shouldShow = false;
        
        switch (filter) {
            case 'all':
                shouldShow = true;
                break;
            case 'recent':
                // æœ€è¿‘ä¸€é€±æŒ‰è®šçš„è²¼æ–‡
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                const likedDate = new Date(post.dataset.likedDate);
                shouldShow = likedDate >= oneWeekAgo;
                break;
            default:
                // æŒ‰å¿ƒæƒ…ç¯©é¸
                shouldShow = post.dataset.mood === filter;
                break;
        }
        
        post.style.display = shouldShow ? 'block' : 'none';
    });
}
</script>

</body>
</html>
