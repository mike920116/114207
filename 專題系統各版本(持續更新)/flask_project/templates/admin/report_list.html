{% extends 'admin/layout.html' %}

{% block title %}Admin - æ„è¦‹å›é¥‹ç®¡ç†{% endblock %}

{% block extra_css %}
<!-- CSS å·²æ•´åˆåˆ° admin.css ä¸­ -->
{% endblock %}

{% block content %}
<div class="admin-content">
  <!-- é é¢æ¨™é¡Œ -->
  <div class="page-header">
    <h1 class="page-title">æ„è¦‹å›é¥‹ç®¡ç†</h1>
    <div class="page-actions">
      <a href="{{ url_for('admin.admin_report_stats') }}" class="btn btn-outline">
        <i class="icon-chart"></i> çµ±è¨ˆå ±è¡¨
      </a>
    </div>
  </div>

  <!-- çµ±è¨ˆå¡ç‰‡ -->
  <div class="stats-grid">
    {% set cards = [
      ('pending',  'å¾…è™•ç†'),
      ('accepted', 'å·²æ¥å—'),
      ('rejected', 'å·²æ‹’çµ•'),
      ('closed',   'å·²é—œé–‰')
    ] %}
    {% for key, label in cards %}
    <div class="stat-card {{ key }}">
      <div class="stat-number" data-count="{{ status_stats.get(key, 0) }}">{{ status_stats.get(key, 0) }}</div>
      <div class="stat-label">{{ label }}</div>
    </div>
    {% endfor %}
  </div>

  <!-- ç¯©é¸å™¨ -->
  <div class="filter-bar">
    <div class="filter-group">
      <label for="status-filter">ç‹€æ…‹ç¯©é¸ï¼š</label>
      <select id="status-filter">
        <option value="all"      {{ 'selected' if status_filter == 'all' }}>å…¨éƒ¨</option>
        <option value="pending"  {{ 'selected' if status_filter == 'pending' }}>å¾…è™•ç†</option>
        <option value="accepted" {{ 'selected' if status_filter == 'accepted' }}>å·²æ¥å—</option>
        <option value="rejected" {{ 'selected' if status_filter == 'rejected' }}>å·²æ‹’çµ•</option>
        <option value="closed"   {{ 'selected' if status_filter == 'closed' }}>å·²é—œé–‰</option>
      </select>
    </div>
  </div>

  <!-- èˆ‰å ±åˆ—è¡¨ -->
  {% if reports %}
  <div class="reports-table-container">
    <!-- æ¡Œé¢ç‰ˆè¡¨æ ¼ -->
    <table class="table d-none d-md-table">
      <thead>
        <tr>
          <th>ID</th><th>èˆ‰å ±è€…</th><th>ä¸»é¡Œ</th><th>é¡å‹</th><th>AI åˆ†æ</th><th>ç‹€æ…‹</th><th>æ™‚é–“</th><th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        {% for report in reports %}
        <tr class="report-row status-{{ report.Status }}">
          <td data-label="ID:">#{{ report.Report_id }}</td>
          <td data-label="èˆ‰å ±è€…:">
            <div class="user-info">
              <div class="user-email">{{ report.User_Email }}</div>
              {% if report.User_name %}<div class="user-name">{{ report.User_name }}</div>{% endif %}
            </div>
          </td>
          <td data-label="ä¸»é¡Œ:">
            <div class="theme-cell">{{ report.Theme[:50] }}{% if report.Theme|length > 50 %}â€¦{% endif %}</div>
          </td>
          <td data-label="é¡å‹:">
            <div class="options-cell">
              {% for option in report.Options[:2] %}<span class="option-tag">{{ option }}</span>{% endfor %}
              {% if report.Options|length > 2 %}<span class="more-options">+{{ report.Options|length - 2 }}</span>{% endif %}
            </div>
          </td>
          <td data-label="AI åˆ†æ:">
            {% if report.AI_Valid is not none %}
            <div class="ai-analysis">
              <span class="ai-result {{ 'valid' if report.AI_Valid else 'invalid' }}">{{ 'âœ“' if report.AI_Valid else '?' }}</span>
              {% if report.AI_Confidence %}<span class="ai-confidence">{{ "%.0f"|format(report.AI_Confidence * 100) }}%</span>{% endif %}
            </div>
            {% else %}<span class="text-muted">-</span>{% endif %}
          </td>
          <td data-label="ç‹€æ…‹:">
            <span class="status-badge status-{{ report.Status }}">
              {% if report.Status == 'pending' %}å¾…è™•ç†
              {% elif report.Status == 'accepted' %}å·²æ¥å—
              {% elif report.Status == 'rejected' %}å·²æ‹’çµ•
              {% elif report.Status == 'closed' %}å·²é—œé–‰{% endif %}
            </span>
          </td>
          <td data-label="æ™‚é–“:">
            <div class="time-cell">
              <div class="created-time">{{ report.Created_at.strftime('%m-%d %H:%M') }}</div>
              {% if report.Updated_at != report.Created_at %}
              <div class="updated-time">æ›´æ–°: {{ report.Updated_at.strftime('%m-%d %H:%M') }}</div>{% endif %}
            </div>
          </td>
          <td data-label="æ“ä½œ:">
            <div class="action-buttons">
              <a href="{{ url_for('admin.admin_report_detail', report_id=report.Report_id) }}" class="btn btn-sm btn-primary">æŸ¥çœ‹</a>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- æ‰‹æ©Ÿç‰ˆå¡ç‰‡ -->
    <div class="d-md-none">
      {% for report in reports %}
      <div class="report-card status-{{ report.Status }}">
        <div class="card-header">
          <div class="report-id">#{{ report.Report_id }}</div>
          <span class="status-badge status-{{ report.Status }}">
            {% if report.Status == 'pending' %}å¾…è™•ç†
            {% elif report.Status == 'accepted' %}å·²æ¥å—
            {% elif report.Status == 'rejected' %}å·²æ‹’çµ•
            {% elif report.Status == 'closed' %}å·²é—œé–‰{% endif %}
          </span>
        </div>
        <div class="card-content">
          <div class="report-theme">{{ report.Theme }}</div>
          <div class="report-user">{{ report.User_Email }}</div>
          <div class="report-options">{% for option in report.Options %}<span class="option-tag">{{ option }}</span>{% endfor %}</div>
          {% if report.AI_Valid is not none %}
          <div class="ai-analysis">
            AI åˆ†æ:
            <span class="ai-result {{ 'valid' if report.AI_Valid else 'invalid' }}">{{ 'æœ‰æ•ˆ' if report.AI_Valid else 'å¾…ç¢ºèª' }}</span>
            {% if report.AI_Confidence %}({{ "%.0f"|format(report.AI_Confidence * 100) }}%){% endif %}
          </div>
          {% endif %}
          <div class="report-time">{{ report.Created_at.strftime('%Y-%m-%d %H:%M') }}</div>
        </div>
        <div class="card-actions">
          <a href="{{ url_for('admin.admin_report_detail', report_id=report.Report_id) }}" class="btn btn-sm btn-primary">æŸ¥çœ‹è©³æƒ…</a>
          {% if report.Status == 'pending' %}
          <button class="btn btn-sm btn-success" data-quick-update data-report-id="{{ report.Report_id }}" data-action="accepted">æ¥å—</button>
          <button class="btn btn-sm btn-danger"  data-quick-update data-report-id="{{ report.Report_id }}" data-action="rejected">æ‹’çµ•</button>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- åˆ†é  -->
  {% if pagination.total_pages > 1 %}
  <div class="pagination-container">
    <nav class="pagination">
      {% if pagination.has_prev %}<a href="?page={{ pagination.prev_num }}&status={{ status_filter }}" class="page-link">ä¸Šä¸€é </a>{% endif %}
      {% for page_num in range(1, pagination.total_pages + 1) %}
        {% if page_num == pagination.page %}
          <span class="page-link current">{{ page_num }}</span>
        {% elif page_num <= 3 or page_num > pagination.total_pages - 3
              or (pagination.page - 1 <= page_num <= pagination.page + 1) %}
          <a href="?page={{ page_num }}&status={{ status_filter }}" class="page-link">{{ page_num }}</a>
        {% elif page_num == 4 or page_num == pagination.total_pages - 3 %}
          <span class="page-ellipsis">â€¦</span>
        {% endif %}
      {% endfor %}
      {% if pagination.has_next %}<a href="?page={{ pagination.next_num }}&status={{ status_filter }}" class="page-link">ä¸‹ä¸€é </a>{% endif %}
    </nav>
    <div class="pagination-info">
      é¡¯ç¤ºç¬¬ {{ (pagination.page - 1) * 20 + 1 }} - {{ min(pagination.page * 20, pagination.total_count) }} é …ï¼Œ å…± {{ pagination.total_count }} é …
    </div>
  </div>
  {% endif %}

  {% else %}
  <!-- ç©ºç‹€æ…‹ -->
  <div class="empty-state">
    <div class="empty-icon">ğŸ“</div>
    <h3>æš«ç„¡èˆ‰å ±è¨˜éŒ„</h3>
    <p>ç•¶ä½¿ç”¨è€…æäº¤èˆ‰å ±æ™‚ï¼Œæœƒåœ¨é€™è£¡é¡¯ç¤º</p>
  </div>
  {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
// ä¿®å¾©ç‹€æ…‹ç¯©é¸åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    const statusFilter = document.getElementById('status-filter');
    
    if (statusFilter) {
        statusFilter.addEventListener('change', function() {
            const selectedStatus = this.value;
            const currentUrl = new URL(window.location.href);
            
            // æ›´æ–°æˆ–æ·»åŠ  status åƒæ•¸
            if (selectedStatus === 'all') {
                currentUrl.searchParams.delete('status');
            } else {
                currentUrl.searchParams.set('status', selectedStatus);
            }
            
            // é‡ç½®é é¢åƒæ•¸
            currentUrl.searchParams.delete('page');
            
            // è·³è½‰åˆ°æ–°çš„ URL
            window.location.href = currentUrl.toString();
        });
    }
    
    // ä¿®å¾©è¡¨æ ¼è¡Œé»æ“Šäº‹ä»¶
    const reportRows = document.querySelectorAll('.report-row');
    reportRows.forEach(row => {
        row.addEventListener('click', function(e) {
            // å¦‚æœé»æ“Šçš„æ˜¯æŒ‰éˆ•æˆ–é€£çµï¼Œä¸è§¸ç™¼è¡Œé»æ“Šäº‹ä»¶
            if (e.target.closest('.btn') || e.target.closest('.action-buttons')) {
                return;
            }
            
            // ç²å–å ±å‘Š ID
            const reportIdElement = row.querySelector('[data-label="ID:"]');
            if (reportIdElement) {
                const reportId = reportIdElement.textContent.replace('#', '');
                if (reportId) {
                    window.location.href = `/admin/report/${reportId}`;
                }
            }
        });
    });
    
    // ä¿®å¾©æ‰‹æ©Ÿå¡ç‰‡é»æ“Šäº‹ä»¶
    const reportCards = document.querySelectorAll('.report-card');
    reportCards.forEach(card => {
        card.addEventListener('click', function(e) {
            // å¦‚æœé»æ“Šçš„æ˜¯æŒ‰éˆ•æˆ–é€£çµï¼Œä¸è§¸ç™¼å¡ç‰‡é»æ“Šäº‹ä»¶
            if (e.target.closest('.btn') || e.target.closest('.card-actions')) {
                return;
            }
            
            // æŸ¥æ‰¾è©³æƒ…é€£çµ
            const detailLink = card.querySelector('a[href*="/admin/report/"]');
            if (detailLink) {
                window.location.href = detailLink.href;
            }
        });
    });
});
</script>
{% endblock %}
