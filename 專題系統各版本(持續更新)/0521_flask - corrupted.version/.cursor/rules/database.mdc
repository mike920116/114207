---
description: 
globs: 
alwaysApply: false
---
# 資料庫結構與使用指南

## 資料表結構

### 使用者表（User）
使用者管理的主要資料表：
- User_Email（主鍵）
- User_name（使用者名稱）
- password_hash（密碼雜湊）
- is_verified（是否驗證）
- email_verification_token（郵件驗證令牌）
- token_expiry（令牌過期時間）
- last_login_time（最後登入時間）
- last_login_ip（最後登入IP）

### 日記記錄（Diary Records）
儲存使用者的日記項目：
- Diary_id（主鍵）
- User_Email（外鍵）
- Diary_Content（日記內容）
- Emotion_status（情緒狀態）
- AI_analysis_content（AI分析內容）
- AI_suggestions（AI建議）
- Created_at（建立時間）
- Updated_at（更新時間）

### AI 聊天會話（AI Chat Sessions）
管理 AI 聊天互動：
- session_id（主鍵）
- user_email（外鍵）
- conversation_id（對話ID）
- is_open（是否開放）
- need_human（是否需要人工介入）
- created_at（建立時間）
- updated_at（更新時間）

### 評論與互動（Comments）
儲存使用者互動：
- Comment_id（主鍵）
- Post_id（外鍵）
- User_Email（外鍵）
- Content（內容）
- Created_at（建立時間）
- Updated_at（更新時間）

## 資料庫連接

資料庫連接應通過 [utils/db.py](mdc:utils/db.py) 管理：

```python
from utils import db

conn = db.get_connection()
try:
    cursor = conn.cursor()
    # 執行查詢
finally:
    cursor.close()
    conn.close()
```

## 最佳實踐

1. 始終使用連接池
2. 在 finally 區塊中關閉連接
3. 使用參數化查詢防止 SQL 注入
4. 妥善處理資料庫錯誤
5. 適當記錄資料庫操作日誌



